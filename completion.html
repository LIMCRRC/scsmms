<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCS Maintenance Completion</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://kit.fontawesome.com/a2d9d6a4d4.js" crossorigin="anonymous"></script>

  <!-- Chart.js for completion charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Custom Styles -->
  <style>
    :root {
      --primary: #2b6cb0;
      --primary-dark: #2c5282;
      --secondary: #e53e3e;
      --accent1: #38a169;
      --accent2: #d69e2e;
      --accent3: #805ad5;
      --light: #f7fafc;
      --dark: #1a202c;
      --gray: #4a5568;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.4;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 13px;
    }

    .options-sidebar {
      width: 180px;
      background: white;
      padding: 0.75rem 0.5rem;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
      border-right: 1px solid #e2e8f0;
      height: 100vh;
      position: sticky;
      top: 0;
      overflow-y: auto;
    }

    .sidebar-section {
      margin-bottom: 1rem;
    }

    .sidebar-header {
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .sidebar-header h2 {
      color: var(--primary);
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      margin-bottom: 1rem;
      background-color: rgba(43, 108, 176, 0.1);
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .user-avatar {
      margin-right: 0.5rem;
    }

    .user-avatar i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .user-details {
      line-height: 1.2;
    }

    .user-name {
      font-weight: 600;
      color: var(--primary-dark);
    }

    .user-position {
      color: var(--gray);
      font-size: 0.7rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      padding: 0.4rem 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      background-color: rgba(0, 0, 0, 0.03);
      font-size: 0.8rem;
    }

    .section-header i {
      margin-right: 0.4rem;
      color: var(--primary);
      font-size: 0.8rem;
    }

    .section-header h3 {
      color: var(--primary-dark);
      font-weight: 600;
      margin: 0;
    }

    .options-list {
      list-style: none;
      margin-bottom: 0;
    }

    .option-item {
      margin-bottom: 0.3rem;
    }

    .option-btn {
      display: flex;
      align-items: center;
      padding: 0.4rem 0.5rem;
      background-color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      transition: var(--transition);
      border: 1px solid #e2e8f0;
      color: var(--gray);
    }

    .option-btn i {
      margin-right: 0.4rem;
      width: 14px;
      text-align: center;
      font-size: 0.7rem;
    }

    .option-btn:hover {
      background-color: #f0f4f8;
      border-color: #cbd5e0;
    }

    .option-btn.active {
      background-color: #ebf4ff;
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    .main-content {
      flex: 1;
      padding: 1rem 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: var(--primary-dark);
      font-weight: 700;
    }

    .welcome-text {
      font-size: 0.8rem;
      color: var(--gray);
      max-width: 1000px;
      margin-bottom: 1rem;
    }

    .card {
      background: white;
      border-radius: 4px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 1rem;
      width: 100%;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .card-header h2 {
      font-size: 1rem;
      color: var(--primary-dark);
      margin: 0;
    }

    /* Month selector */
    .month-selector {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }

    .month-selector label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .month-selector select {
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
      background-color: white;
      font-size: 0.8rem;
      color: var(--dark);
    }

    /* Summary cards */
    .completion-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .summary-card {
      background: white;
      border-radius: 4px;
      padding: 0.8rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }

    .summary-card h3 {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .summary-card h3 i {
      font-size: 0.8rem;
    }

    .completion-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.4rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--gray);
    }

    .stat-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--dark);
    }

    .completion-bar {
      height: 8px;
      background-color: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.4rem;
    }

    .completion-progress {
      height: 100%;
      background-color: var(--accent1);
      border-radius: 4px;
    }

    .completion-percentage {
      font-size: 0.75rem;
      font-weight: 600;
      text-align: right;
      color: var(--accent1);
    }

    /* Depot completion cards - smaller and simplified */
    .depot-completion {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.6rem;
      margin-bottom: 1rem;
    }

    .depot-card {
      background: white;
      border-radius: 4px;
      padding: 0.6rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    .depot-card h3 {
      font-size: 0.75rem;
      margin-bottom: 0.4rem;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }

    .depot-card h3 i {
      font-size: 0.7rem;
    }

    .depot-actual {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
    }

    .depot-label {
      font-size: 0.65rem;
      color: var(--gray);
      margin-top: 0.2rem;
    }

    /* Chart section */
    .chart-filters {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .chart-filter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-filter label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .chart-filter select {
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
      background-color: white;
      font-size: 0.8rem;
      color: var(--dark);
    }

    .chart-container {
      background: white;
      border-radius: 4px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
      height: 400px;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #2b6cb0;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 10px;
    }

    .loading-text {
      color: #2c5282;
      font-weight: 500;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .completion-summary,
      .depot-completion {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
        font-size: 12px;
      }
      
      .options-sidebar {
        width: 100%;
        height: auto;
        position: relative;
        padding: 0.6rem;
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .main-content {
        padding: 0.8rem;
        height: auto;
      }
      
      .completion-summary,
      .depot-completion {
        grid-template-columns: 1fr;
      }
    }

    /* Collapsible sidebar items */
    .collapsible .submenu {
      display: none;
      padding-left: 0.5rem;
      list-style: none;
      margin-top: 0.3rem;
    }

    .collapsible.active .submenu {
      display: block;
    }

    .collapsible .option-btn {
      position: relative;
    }

    .collapsible .toggle-icon {
      transition: transform 0.3s ease;
      font-size: 0.7rem;
      margin-left: auto;
    }

    .collapsible.active .toggle-icon {
      transform: rotate(180deg);
    }

    /* Ensure consistent font sizes in submenu */
    .submenu .option-btn {
      font-size: 0.75rem;
      padding: 0.35rem 0.5rem;
    }

    .submenu .option-btn i {
      font-size: 0.7rem;
      width: 14px;
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading data...</div>
  </div>

  <!-- Sidebar Options -->
   <div class="options-sidebar">
        <div class="sidebar-header">
            <h2>SCS Dashboard</h2>
        </div>
        
        <div class="user-info">
            <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-details">
                <div class="user-name" id="loggedInName">Loading...</div>
                <div class="user-position" id="loggedInPosition">Loading...</div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <ul class="options-list">
                <li class="option-item">
                    <a href="#" class="option-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh Data</span>
                    </a>
                </li>
                <li class="option-item">
                    <a href="index.html" class="option-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </div>

    <div class="sidebar-section">
      <div class="section-header">
        <i class="fas fa-tools"></i>
        <h3>Maintenance</h3>
      </div>
      
      <ul class="options-list">
        <li class="option-item">
          <a href="#" class="option-btn" id="dashboardBtn">
            <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
          </a>
        </li>

        <li class="option-item">
          <a href="mileage.html" class="option-btn">
            <i class="fas fa-calendar-check"></i><span>Mileage</span>
          </a>
        </li>

        <li class="option-item">
          <a href="plan-view.html" class="option-btn">
            <i class="fas fa-calendar-check"></i><span>Plan</span>
          </a>
        </li>

        <li class="option-item">
            <a href="#" class="option-btn active" id="completionSummaryBtn">
              <i class="fas fa-clipboard-check"></i><span>Maint. Completion</span>
            </a>
        </li>

        <li class="option-item">
            <a href="#" class="option-btn" id="failureSummaryBtn">
              <i class="fas fa-exclamation-triangle"></i><span>Failure</span>
            </a>
        </li>

        <li class="option-item">
            <a href="#" class="option-btn" id="unscheduledSummaryBtn">
              <i class="fas fa-wrench"></i><span>Uns. Maintenance</span>
            </a>
        </li>

        <li class="option-item">
            <a href="#" class="option-btn" id="warrantySummaryBtn">
              <i class="fas fa-file-contract"></i><span>Warranty</span>
            </a>
        </li>
      </ul>
    </div>
    </div>

  <!-- Main Content -->
  <div class="main-content">
    <h1><i class="fas fa-check-circle"></i> Maintenance Completion</h1>
    <p class="welcome-text">Track maintenance completion rates for daily, weekly, and monthly activities. Today: <span id="todayDate"></span></p>

    <!-- Month Selector -->
    <div class="month-selector">
      <label for="reportingMonth">Reporting Month:</label>
      <select id="reportingMonth">
        <option value="">Loading months...</option>
      </select>
    </div>

    <!-- Completion Summary Cards -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-chart-pie"></i> Completion Summary</h2>
      </div>
      
      <div class="completion-summary">
        <!-- Daily Completion -->
        <div class="summary-card">
          <h3><i class="fas fa-calendar-day"></i> Daily Maintenance</h3>
          <div class="completion-stats">
            <div>
              <div class="stat-label">Planned</div>
              <div class="stat-value" id="dailyPlanned">0</div>
            </div>
            <div>
              <div class="stat-label">Actual</div>
              <div class="stat-value" id="dailyActual">0</div>
            </div>
          </div>
          <div class="completion-bar">
            <div class="completion-progress" id="dailyProgress" style="width: 0%"></div>
          </div>
          <div class="completion-percentage" id="dailyPercentage">0%</div>
        </div>
        
        <!-- Weekly Completion -->
        <div class="summary-card">
          <h3><i class="fas fa-calendar-week"></i> Weekly Maintenance</h3>
          <div class="completion-stats">
            <div>
              <div class="stat-label">Planned</div>
              <div class="stat-value" id="weeklyPlanned">0</div>
            </div>
            <div>
              <div class="stat-label">Actual</div>
              <div class="stat-value" id="weeklyActual">0</div>
            </div>
          </div>
          <div class="completion-bar">
            <div class="completion-progress" id="weeklyProgress" style="width: 0%"></div>
          </div>
          <div class="completion-percentage" id="weeklyPercentage">0%</div>
        </div>
        
        <!-- Monthly Completion -->
        <div class="summary-card">
          <h3><i class="fas fa-calendar-alt"></i> Monthly Maintenance</h3>
          <div class="completion-stats">
            <div>
              <div class="stat-label">Planned</div>
              <div class="stat-value" id="monthlyPlanned">0</div>
            </div>
            <div>
              <div class="stat-label">Actual</div>
              <div class="stat-value" id="monthlyActual">0</div>
            </div>
          </div>
          <div class="completion-bar">
            <div class="completion-progress" id="monthlyProgress" style="width: 0%"></div>
          </div>
          <div class="completion-percentage" id="monthlyPercentage">0%</div>
        </div>
      </div>
    </div>

    <!-- Depot Completion Cards - Simplified -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-map-marker-alt"></i> Depot Completion</h2>
      </div>
      
      <div class="depot-completion">
        <!-- Sentul -->
        <div class="depot-card">
          <h3><i class="fas fa-building"></i> Sentul (ST)</h3>
          <div class="depot-actual" id="stActual">0</div>
          <div class="depot-label">Completed</div>
        </div>
        
        <!-- Seremban -->
        <div class="depot-card">
          <h3><i class="fas fa-building"></i> Seremban (SB)</h3>
          <div class="depot-actual" id="sbActual">0</div>
          <div class="depot-label">Completed</div>
        </div>
        
        <!-- Port Klang -->
        <div class="depot-card">
          <h3><i class="fas fa-building"></i> Port Klang (PK)</h3>
          <div class="depot-actual" id="pkActual">0</div>
          <div class="depot-label">Completed</div>
        </div>
        
        <!-- Tanjung Malim -->
        <div class="depot-card">
          <h3><i class="fas fa-building"></i> Tanjung Malim (TM)</h3>
          <div class="depot-actual" id="tmActual">0</div>
          <div class="depot-label">Completed</div>
        </div>
        
        <!-- Bukit Tengah -->
        <div class="depot-card">
          <h3><i class="fas fa-building"></i> Bukit Tengah (BT)</h3>
          <div class="depot-actual" id="btActual">0</div>
          <div class="depot-label">Completed</div>
        </div>
        
        <!-- Padang Besar -->
        <div class="depot-card">
          <h3><i class="fas fa-building"></i> Padang Besar (PB)</h3>
          <div class="depot-actual" id="pbActual">0</div>
          <div class="depot-label">Completed</div>
        </div>
      </div>
    </div>

    <!-- Completion Chart -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-chart-bar"></i> Completion Trend</h2>
      </div>
      
<div style="overflow-x: auto;">
    <table id="detailsTable" style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
      <thead>
        <tr style="background-color: var(--primary); color: white; text-align: left;">
          <th style="padding: 8px; border: 1px solid #ddd;">Train Set</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Current Location</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Plan Completion (%)</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Status</th>
        </tr>
      </thead>
      <tbody id="detailsTableBody">
        </tbody>
    </table>
  </div>

      <div class="chart-filters">
        <div class="chart-filter">
          <label for="trainSetFilter">Train Set:</label>
          <select id="trainSetFilter">
            <option value="">Please select train set</option>
            <!-- Will be populated by JavaScript -->
          </select>
        </div>
        
        <div class="chart-filter">
          <label for="maintenanceTypeFilter">Maintenance Type:</label>
          <select id="maintenanceTypeFilter">
            <option value="all">All Types</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="completionChart"></canvas>
      </div>
    </div>
  </div>

  <script>
const CONFIG = {
    scriptUrl: 'https://script.google.com/macros/s/AKfycbwVO4nV46goTQkD-tqD9ZoPgZTG3YGg_-wJ9-r4u9sM8TBiG5U7SN4PnZXgpF-ivwp--Q/exec'
  };
let completionChart = null;

  // Loading Overlay Functions
  function showLoadingOverlay(message = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.querySelector('.loading-text').textContent = message;
      overlay.style.display = 'flex';
    }
  }

  function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'none';
  }

  // Format date as yyyy-mm-dd
  function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  // Format date as dd-mmm-yyyy (e.g., 03-Sep-2025)
  function formatDateDisplay(date) {
    if (!date || isNaN(date.getTime())) {
      return "No date";
    }
    
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const day = String(date.getDate()).padStart(2, '0');
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
  }

  // Get URL parameter
  function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  }

  // Generate reporting months (from Aug-24 to Jan-26)
  function generateReportingMonths() {
    const select = document.getElementById('reportingMonth');
    select.innerHTML = '';
    
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    // Add months from Aug-24 to Jan-26
    for (let year = 2024; year <= 2026; year++) {
      const startMonth = year === 2024 ? 7 : 0; // August is month 7 (0-indexed)
      const endMonth = year === 2026 ? 0 : 11; // January is month 0 (0-indexed)
      
      for (let month = startMonth; month <= (year === 2026 ? endMonth : 11); month++) {
        // Stop at January 2026
        if (year === 2026 && month > 0) break;
        
        const option = document.createElement('option');
        option.value = `${year}-${String(month + 1).padStart(2, '0')}`;
        option.textContent = `${monthNames[month]}-${String(year).slice(2)}`;
        
        // Select current month by default
        const currentDate = new Date();
        if (year === currentDate.getFullYear() && month === currentDate.getMonth()) {
          option.selected = true;
        }
        
        select.appendChild(option);
      }
    }
  }

function renderDetailsTable(data) {
  const tbody = document.getElementById('detailsTableBody');
  tbody.innerHTML = '';

  const locations = data.locations.slice(1);
  const completion = data.completion.slice(1);

  locations.forEach(locRow => {
    const trainId = locRow[0];
    const compRow = completion.find(c => c[0] === trainId) || [trainId, '0%'];

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding: 8px; border: 1px solid #ddd;">${trainId}</td>
      <td style="padding: 8px; border: 1px solid #ddd;">${locRow[1] || 'N/A'}</td>
      <td style="padding: 8px; border: 1px solid #ddd;">
        <div style="background:#eee; border-radius:4px; height:10px; width:100px; display:inline-block; margin-right:5px;">
          <div style="background:var(--accent1); height:100%; width:${compRow[1]}"></div>
        </div>
        ${compRow[1]}
      </td>
      <td style="padding: 8px; border: 1px solid #ddd;">${locRow[2] || 'Active'}</td>
    `;
    tbody.appendChild(tr);
  });
}

  // Update completion summary cards - FIXED to match backend data structure
  function updateCompletionSummary(data) {
    // Update daily completion
    document.getElementById('dailyPlanned').textContent = data.daily.planned || 0;
    document.getElementById('dailyActual').textContent = data.daily.actual || 0;
    const dailyPercentage = data.daily.planned ? Math.round((data.daily.actual / data.daily.planned) * 100) : 0;
    document.getElementById('dailyProgress').style.width = `${dailyPercentage}%`;
    document.getElementById('dailyPercentage').textContent = `${dailyPercentage}%`;
    
    // Update weekly completion
    document.getElementById('weeklyPlanned').textContent = data.weekly.planned || 0;
    document.getElementById('weeklyActual').textContent = data.weekly.actual || 0;
    const weeklyPercentage = data.weekly.planned ? Math.round((data.weekly.actual / data.weekly.planned) * 100) : 0;
    document.getElementById('weeklyProgress').style.width = `${weeklyPercentage}%`;
    document.getElementById('weeklyPercentage').textContent = `${weeklyPercentage}%`;
    
    // Update monthly completion
    document.getElementById('monthlyPlanned').textContent = data.monthly.planned || 0;
    document.getElementById('monthlyActual').textContent = data.monthly.actual || 0;
    const monthlyPercentage = data.monthly.planned ? Math.round((data.monthly.actual / data.monthly.planned) * 100) : 0;
    document.getElementById('monthlyProgress').style.width = `${monthlyPercentage}%`;
    document.getElementById('monthlyPercentage').textContent = `${monthlyPercentage}%`;
  }

  // Update depot completion cards - FIXED to match backend data structure
  function updateDepotCompletion(data) {
    const depots = ['st', 'sb', 'pk', 'tm', 'bt', 'pb'];
    
    depots.forEach(depot => {
      if (data[depot]) {
        document.getElementById(`${depot}Actual`).textContent = data[depot].actual || 0;
      }
    });
  }

  // Populate train set dropdown
  function populateTrainSetDropdown() {
    const select = document.getElementById('trainSetFilter');
    select.innerHTML = '<option value="">Please select train set</option>';
    
    // Generate options T01 to T38
    for (let i = 1; i <= 38; i++) {
      const option = document.createElement('option');
      option.value = `T${String(i).padStart(2, '0')}`;
      option.textContent = `T${String(i).padStart(2, '0')}`;
      select.appendChild(option);
    }
  }

  // Create completion chart - updated to use empty data initially
  function createCompletionChart(labels = [], plannedData = [], actualData = []) {
    const ctx = document.getElementById('completionChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (completionChart) {
      completionChart.destroy();
    }
    
    // Show message if no data
    if (labels.length === 0) {
      ctx.font = "16px Arial";
      ctx.fillStyle = "#666";
      ctx.textAlign = "center";
      ctx.fillText("Select a train set to view completion trend", ctx.canvas.width / 2, ctx.canvas.height / 2);
      return;
    }
    
    completionChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Planned Maintenance',
            data: plannedData,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Actual Completion',
            data: actualData,
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Maintenance Activities'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Reporting Month'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Maintenance Completion Trend'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          },
          legend: {
            position: 'top'
          }
        }
      }
    });
  }

  // Fetch completion data from Google Sheets
  async function fetchCompletionData(month, year) {
  showLoadingOverlay('Fetching completion data...');

  try {
    const response = await fetch(
      `${CONFIG.scriptUrl}?action=getCompletionData&month=${month}&year=${year}`
    );

    const data = await response.json();

    if (data.success) {
      updateCompletionSummary(data.data.summary);
      updateDepotCompletion(data.data.depots);
      createCompletionChart();
    } else {
      alert('Failed to load completion data. Please try again.');
    }

  } catch (error) {
    alert('Error loading completion data. Please check your connection.');
  } finally {
    hideLoadingOverlay();
  }
}

  // Initialize page
  function initPage() {
    // Set today's date
    document.getElementById('todayDate').textContent = formatDateDisplay(new Date());
    
    // Set user info from URL parameters or defaults
    const userName = getUrlParameter('name') || 'John Doe';
    const userPosition = getUrlParameter('position') || 'Maintenance Manager';
    document.getElementById('loggedInName').textContent = userName;
    document.getElementById('loggedInPosition').textContent = userPosition;
    
    // Generate reporting months
    generateReportingMonths();
    
    // Populate train set dropdown
    populateTrainSetDropdown();
    
    // Add event listener for month selection
    document.getElementById('reportingMonth').addEventListener('change', function() {
      const [year, month] = this.value.split('-');
      fetchCompletionData(parseInt(month), parseInt(year));
    });
    
    // Add event listener for refresh button
    document.getElementById('refreshBtn').addEventListener('click', function(e) {
      e.preventDefault();
      const select = document.getElementById('reportingMonth');
      const [year, month] = select.value.split('-');
      fetchCompletionData(parseInt(month), parseInt(year));
    });
    
    // Add event listener for train set filter
    document.getElementById('trainSetFilter').addEventListener('change', function() {
      // This would fetch historical data for the selected train set
      // For now, we'll just show a message
      if (this.value) {
        createCompletionChart();
        const ctx = document.getElementById('completionChart').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = "16px Arial";
        ctx.fillStyle = "#666";
        ctx.textAlign = "center";
        ctx.fillText(`Historical data for ${this.value} would be shown here`, ctx.canvas.width / 2, ctx.canvas.height / 2);
      } else {
        createCompletionChart();
      }
    });
    
      
    // Load initial data for current month
    const currentDate = new Date();
    fetchCompletionData(currentDate.getMonth() + 1, currentDate.getFullYear());
  }

  // Initialize the page when DOM is loaded
  document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>